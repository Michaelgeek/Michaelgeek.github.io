
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>Bound Services | Michael&#39;s Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="Michael">
    
    <meta name="description" content="最近工作上的开发，许多与framework有关：跨进程通信、service和AIDL。这里结合官方文档总结一下。
什么是Bound Services？
Bound Services是一种能接受其他组件绑定的services。组件通过与它绑定，可以向services发起调用，services应答并可以">
    
    
    
    
    <link rel="alternate" href="http://michaelgeek.github.io/" title="Michael&#39;s Blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/pacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/pacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

  <body>
    <header>
      <div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.svg" alt="Michael&#39;s Blog" title="Michael&#39;s Blog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Michael&#39;s Blog">Michael&#39;s Blog</a></h1>
				<h2 class="blog-motto">90后程序员 移动开发者</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
					<li>
					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="text" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
					</form>
					
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/10/19/bound-services/" title="Bound Services" itemprop="url">Bound Services</a>
  </h1>
  <p class="article-author">By
    
      <a href="https://plus.google.com/100262645697225607342?rel=author" title="Michael" target="_blank" itemprop="author">Michael</a>
    </p>
  <p class="article-time">
    <time datetime="2015-10-19T08:54:26.000Z" itemprop="datePublished">10月 19 2015</time>
    更新日期:<time datetime="2015-10-19T09:45:07.000Z" itemprop="dateModified">10月 19 2015</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#什么是Bound_Services？"><span class="toc-number">1.</span> <span class="toc-text">什么是Bound Services？</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#构造一个Bound_Services"><span class="toc-number">2.</span> <span class="toc-text">构造一个Bound Services</span></a></li><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#直接实现IBinder接口。"><span class="toc-number">2.1.</span> <span class="toc-text">直接实现IBinder接口。</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用Messenger（Messenger的内部也是使用AIDL实现的）。"><span class="toc-number">2.2.</span> <span class="toc-text">使用Messenger（Messenger的内部也是使用AIDL实现的）。</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用AIDL"><span class="toc-number">2.3.</span> <span class="toc-text">使用AIDL</span></a></li><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建-aidl文件。"><span class="toc-number">2.3.1.</span> <span class="toc-text">创建.aidl文件。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#service端实现接口。"><span class="toc-number">2.3.2.</span> <span class="toc-text">service端实现接口。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#service返回接口对象给client。"><span class="toc-number">2.3.3.</span> <span class="toc-text">service返回接口对象给client。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#client获取service端接口。"><span class="toc-number">2.3.4.</span> <span class="toc-text">client获取service端接口。</span></a></li></ol></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#绑定Service。"><span class="toc-number">3.</span> <span class="toc-text">绑定Service。</span></a></li></ol>
		</div>
		
		<p>最近工作上的开发，许多与framework有关：跨进程通信、service和AIDL。这里结合官方文档总结一下。</p>
<h1 id="什么是Bound_Services？">什么是Bound Services？</h1>
<p>Bound Services是一种能接受其他组件绑定的services。组件通过与它绑定，可以向services发起调用，services应答并可以反馈消息。组件也称client端，这里的组件指三种：activity、service、content provider。</p>
<h1 id="构造一个Bound_Services">构造一个Bound Services</h1>
<p>Bound Services需要提供一个实现了IBinder接口的对象，用于client与services通信。该对象在public IBinder onBind(Intent intent)返回给client。services提供三种方式获取IBinder对象。</p>
<h2 id="直接实现IBinder接口。">直接实现IBinder接口。</h2>
<p>这种方法使用的场景是，services是当前应用私有的，只为当前应用服务。代码如下（注：本文所有代码来自谷歌官网文档）</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
</pre></td><td class="code"><pre><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LocalService</span> <span class="keyword">extends</span> <span class="title">Service</span> {</span>
    <span class="comment">// Binder given to clients</span>
    <span class="keyword">private</span> <span class="keyword">final</span> IBinder mBinder = <span class="keyword">new</span> LocalBinder();
    <span class="comment">// Random number generator</span>
    <span class="keyword">private</span> <span class="keyword">final</span> Random mGenerator = <span class="keyword">new</span> Random();

    <span class="javadoc">/**
     * Class used for the client Binder.  Because we know this service always
     * runs in the same process as its clients, we don't need to deal with IPC.
     */</span>
    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LocalBinder</span> <span class="keyword">extends</span> <span class="title">Binder</span> {</span>
        LocalService getService() {
            <span class="comment">// Return this instance of LocalService so clients can call public methods</span>
            <span class="keyword">return</span> LocalService.<span class="keyword">this</span>;
        }
    }

    <span class="annotation">@Override</span>
    <span class="keyword">public</span> IBinder <span class="title">onBind</span>(Intent intent) {
        <span class="keyword">return</span> mBinder;
    }

    <span class="javadoc">/** method for clients */</span>
    <span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getRandomNumber</span>() {
      <span class="keyword">return</span> mGenerator.nextInt(<span class="number">100</span>);
    }
}


<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BindingActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> {</span>
    LocalService mService;
    <span class="keyword">boolean</span> mBound = <span class="keyword">false</span>;

    <span class="annotation">@Override</span>
    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span>(Bundle savedInstanceState) {
        <span class="keyword">super</span>.onCreate(savedInstanceState);
        setContentView(R.layout.main);
    }

    <span class="annotation">@Override</span>
    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onStart</span>() {
        <span class="keyword">super</span>.onStart();
        <span class="comment">// Bind to LocalService</span>
        Intent intent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, LocalService.class);
        bindService(intent, mConnection, Context.BIND_AUTO_CREATE);
    }

    <span class="annotation">@Override</span>
    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onStop</span>() {
        <span class="keyword">super</span>.onStop();
        <span class="comment">// Unbind from the service</span>
        <span class="keyword">if</span> (mBound) {
            unbindService(mConnection);
            mBound = <span class="keyword">false</span>;
        }
    }

    <span class="javadoc">/** Called when a button is clicked (the button in the layout file attaches to
      * this method with the android:onClick attribute) */</span>
    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onButtonClick</span>(View v) {
        <span class="keyword">if</span> (mBound) {
            <span class="comment">// Call a method from the LocalService.</span>
            <span class="comment">// However, if this call were something that might hang, then this request should</span>
            <span class="comment">// occur in a separate thread to avoid slowing down the activity performance.</span>
            <span class="keyword">int</span> num = mService.getRandomNumber();
            Toast.makeText(<span class="keyword">this</span>, <span class="string">"number: "</span> + num, Toast.LENGTH_SHORT).show();
        }
    }

    <span class="javadoc">/** Defines callbacks for service binding, passed to bindService() */</span>
    <span class="keyword">private</span> ServiceConnection mConnection = <span class="keyword">new</span> ServiceConnection() {

        <span class="annotation">@Override</span>
        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span>(ComponentName className,
                IBinder service) {
            <span class="comment">// We've bound to LocalService, cast the IBinder and get LocalService instance</span>
            LocalBinder binder = (LocalBinder) service;
            mService = binder.getService();
            mBound = <span class="keyword">true</span>;
        }

        <span class="annotation">@Override</span>
        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span>(ComponentName arg0) {
            mBound = <span class="keyword">false</span>;
        }
    };
}
</pre></td></tr></table></figure>


<h2 id="使用Messenger（Messenger的内部也是使用AIDL实现的）。">使用Messenger（Messenger的内部也是使用AIDL实现的）。</h2>
<p>（1）services通过构造一个handler H接受client的消息 （2）使用H构造一个Messenger M（3）在onBind()返回M.getBinder()  (4)client在onServiceConnected(ComponentName className,IBinder binder)中，使用binder构造一个Messenger，使用这个Messenger就可以向services发送消息，services在H接收消息。（5）client如果想接受services的消息，则client发送的消息体Message的replyTo参数带上自己Messenger即可。代码如下</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
</pre></td><td class="code"><pre><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessengerService</span> <span class="keyword">extends</span> <span class="title">Service</span> {</span>
    <span class="javadoc">/** Command to the service to display a message */</span>
    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_SAY_HELLO = <span class="number">1</span>;

    <span class="javadoc">/**
     * Handler of incoming messages from clients.
     */</span>
    class IncomingHandler extends Handler {
        <span class="annotation">@Override</span>
        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span>(Message msg) {
            <span class="keyword">switch</span> (msg.what) {
                <span class="keyword">case</span> MSG_SAY_HELLO:
                    Toast.makeText(getApplicationContext(), <span class="string">"hello!"</span>, Toast.LENGTH_SHORT).show();
                    <span class="keyword">break</span>;
                <span class="keyword">default</span>:
                    <span class="keyword">super</span>.handleMessage(msg);
            }
        }
    }

    <span class="javadoc">/**
     * Target we publish for clients to send messages to IncomingHandler.
     */</span>
    <span class="keyword">final</span> Messenger mMessenger = <span class="keyword">new</span> Messenger(<span class="keyword">new</span> IncomingHandler());

    <span class="javadoc">/**
     * When binding to the service, we return an interface to our messenger
     * for sending messages to the service.
     */</span>
    <span class="annotation">@Override</span>
    <span class="keyword">public</span> IBinder <span class="title">onBind</span>(Intent intent) {
        Toast.makeText(getApplicationContext(), <span class="string">"binding"</span>, Toast.LENGTH_SHORT).show();
        <span class="keyword">return</span> mMessenger.getBinder();
    }
}
<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityMessenger</span> <span class="keyword">extends</span> <span class="title">Activity</span> {</span>
    <span class="javadoc">/** Messenger for communicating with the service. */</span>
    Messenger mService = <span class="keyword">null</span>;

    <span class="javadoc">/** Flag indicating whether we have called bind on the service. */</span>
    <span class="keyword">boolean</span> mBound;

    <span class="javadoc">/**
     * Class for interacting with the main interface of the service.
     */</span>
    <span class="keyword">private</span> ServiceConnection mConnection = <span class="keyword">new</span> ServiceConnection() {
        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span>(ComponentName className, IBinder service) {
            <span class="comment">// This is called when the connection with the service has been</span>
            <span class="comment">// established, giving us the object we can use to</span>
            <span class="comment">// interact with the service.  We are communicating with the</span>
            <span class="comment">// service using a Messenger, so here we get a client-side</span>
            <span class="comment">// representation of that from the raw IBinder object.</span>
            mService = <span class="keyword">new</span> Messenger(service);
            mBound = <span class="keyword">true</span>;
        }

        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span>(ComponentName className) {
            <span class="comment">// This is called when the connection with the service has been</span>
            <span class="comment">// unexpectedly disconnected -- that is, its process crashed.</span>
            mService = <span class="keyword">null</span>;
            mBound = <span class="keyword">false</span>;
        }
    };

    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHello</span>(View v) {
        <span class="keyword">if</span> (!mBound) <span class="keyword">return</span>;
        <span class="comment">// Create and send a message to the service, using a supported 'what' value</span>
        Message msg = Message.obtain(<span class="keyword">null</span>, MessengerService.MSG_SAY_HELLO, <span class="number">0</span>, <span class="number">0</span>);
        <span class="keyword">try</span> {
            mService.send(msg);
        } <span class="keyword">catch</span> (RemoteException e) {
            e.printStackTrace();
        }
    }

    <span class="annotation">@Override</span>
    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span>(Bundle savedInstanceState) {
        <span class="keyword">super</span>.onCreate(savedInstanceState);
        setContentView(R.layout.main);
    }

    <span class="annotation">@Override</span>
    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onStart</span>() {
        <span class="keyword">super</span>.onStart();
        <span class="comment">// Bind to the service</span>
        bindService(<span class="keyword">new</span> Intent(<span class="keyword">this</span>, MessengerService.class), mConnection,
            Context.BIND_AUTO_CREATE);
    }

    <span class="annotation">@Override</span>
    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onStop</span>() {
        <span class="keyword">super</span>.onStop();
        <span class="comment">// Unbind from the service</span>
        <span class="keyword">if</span> (mBound) {
            unbindService(mConnection);
            mBound = <span class="keyword">false</span>;
        }
    }
}
</pre></td></tr></table></figure>


<h2 id="使用AIDL">使用AIDL</h2>
<p>android接口定义语言。定义了程序接口，这些接口client和service端都能使用，能进行跨进程调用。</p>
<h3 id="创建-aidl文件。">创建.aidl文件。</h3>
<p>使用java语法创建后缀为.aidl的接口文件。放在service端的src目录，并且所有需要bind service的app也需要将aidl文件放入src。Android SDK Tool会根据aidl文件生成java接口。aidl文件及生成的java文件如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
</pre></td><td class="code"><pre><span class="comment">// IRemoteService.aidl</span>
<span class="keyword">package</span> com.example.myapp;

<span class="comment">// Declare any non-default types here with import statements</span>

<span class="javadoc">/** Example service interface */</span>
interface IRemoteService {
<span class="javadoc">/** Request the process ID of this service, to do evil things with it. */</span>
<span class="keyword">int</span> getPid();

<span class="javadoc">/** Demonstrates some basic types that you can use as parameters
* and return values in AIDL.
*/</span>
<span class="keyword">void</span> basicTypes(<span class="keyword">int</span> anInt, <span class="keyword">long</span> aLong, <span class="keyword">boolean</span> aBoolean, <span class="keyword">float</span> aFloat,
<span class="keyword">double</span> aDouble, String aString);
}

<span class="comment">/*___Generated_by_IDEA___*/</span>

<span class="comment">/*
 * This file is auto-generated.  DO NOT MODIFY.
 * Original file: /Users/kongyouji/github/test/src/com/example/myapp/IRemoteService.aidl
 */</span>
<span class="keyword">package</span> com.example.myapp;
<span class="comment">// Declare any non-default types here with import statements</span>

<span class="javadoc">/**
 * Example service interface
 */</span>
<span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IRemoteService</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">os</span>.<span class="title">IInterface</span> {</span>
    <span class="javadoc">/**
     * Local-side IPC implementation stub class.
     */</span>
    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Stub</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">os</span>.<span class="title">Binder</span> <span class="keyword">implements</span> <span class="title">com</span>.<span class="title">example</span>.<span class="title">myapp</span>.<span class="title">IRemoteService</span> {</span>
        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> java.lang.String DESCRIPTOR = <span class="string">"com.example.myapp.IRemoteService"</span>;

        <span class="javadoc">/**
         * Construct the stub at attach it to the interface.
         */</span>
        <span class="keyword">public</span> <span class="title">Stub</span>() {
            <span class="keyword">this</span>.attachInterface(<span class="keyword">this</span>, DESCRIPTOR);
        }

        <span class="javadoc">/**
         * Cast an IBinder object into an com.example.myapp.IRemoteService interface,
         * generating a proxy if needed.
         */</span>
        <span class="keyword">public</span> <span class="keyword">static</span> com.example.myapp.IRemoteService <span class="title">asInterface</span>(android.os.IBinder obj) {
            <span class="keyword">if</span> ((obj == <span class="keyword">null</span>)) {
                <span class="keyword">return</span> <span class="keyword">null</span>;
            }
            android.os.IInterface iin = obj.queryLocalInterface(DESCRIPTOR);
            <span class="keyword">if</span> (((iin != <span class="keyword">null</span>) && (iin <span class="keyword">instanceof</span> com.example.myapp.IRemoteService))) {
                <span class="keyword">return</span> ((com.example.myapp.IRemoteService) iin);
            }
            <span class="keyword">return</span> <span class="keyword">new</span> com.example.myapp.IRemoteService.Stub.Proxy(obj);
        }

        <span class="annotation">@Override</span>
        <span class="keyword">public</span> android.os.IBinder <span class="title">asBinder</span>() {
            <span class="keyword">return</span> <span class="keyword">this</span>;
        }

        <span class="annotation">@Override</span>
        <span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span>(<span class="keyword">int</span> code, android.os.Parcel data, android.os.Parcel reply, <span class="keyword">int</span> flags) <span class="keyword">throws</span> android.os.RemoteException {
            <span class="keyword">switch</span> (code) {
                <span class="keyword">case</span> INTERFACE_TRANSACTION: {
                    reply.writeString(DESCRIPTOR);
                    <span class="keyword">return</span> <span class="keyword">true</span>;
                }
                <span class="keyword">case</span> TRANSACTION_getPid: {
                    data.enforceInterface(DESCRIPTOR);
                    <span class="keyword">int</span> _result = <span class="keyword">this</span>.getPid();
                    reply.writeNoException();
                    reply.writeInt(_result);
                    <span class="keyword">return</span> <span class="keyword">true</span>;
                }
                <span class="keyword">case</span> TRANSACTION_basicTypes: {
                    data.enforceInterface(DESCRIPTOR);
                    <span class="keyword">int</span> _arg0;
                    _arg0 = data.readInt();
                    <span class="keyword">long</span> _arg1;
                    _arg1 = data.readLong();
                    <span class="keyword">boolean</span> _arg2;
                    _arg2 = (<span class="number">0</span> != data.readInt());
                    <span class="keyword">float</span> _arg3;
                    _arg3 = data.readFloat();
                    <span class="keyword">double</span> _arg4;
                    _arg4 = data.readDouble();
                    java.lang.String _arg5;
                    _arg5 = data.readString();
                    <span class="keyword">this</span>.basicTypes(_arg0, _arg1, _arg2, _arg3, _arg4, _arg5);
                    reply.writeNoException();
                    <span class="keyword">return</span> <span class="keyword">true</span>;
                }
            }
            <span class="keyword">return</span> <span class="keyword">super</span>.onTransact(code, data, reply, flags);
        }

        <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Proxy</span> <span class="keyword">implements</span> <span class="title">com</span>.<span class="title">example</span>.<span class="title">myapp</span>.<span class="title">IRemoteService</span> {</span>
            <span class="keyword">private</span> android.os.IBinder mRemote;

            Proxy(android.os.IBinder remote) {
                mRemote = remote;
            }

            <span class="annotation">@Override</span>
            <span class="keyword">public</span> android.os.IBinder <span class="title">asBinder</span>() {
                <span class="keyword">return</span> mRemote;
            }

            <span class="keyword">public</span> java.lang.String <span class="title">getInterfaceDescriptor</span>() {
                <span class="keyword">return</span> DESCRIPTOR;
            }

            <span class="javadoc">/**
             * Request the process ID of this service, to do evil things with it.
             */</span>
            <span class="annotation">@Override</span>
            <span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPid</span>() <span class="keyword">throws</span> android.os.RemoteException {
                android.os.Parcel _data = android.os.Parcel.obtain();
                android.os.Parcel _reply = android.os.Parcel.obtain();
                <span class="keyword">int</span> _result;
                <span class="keyword">try</span> {
                    _data.writeInterfaceToken(DESCRIPTOR);
                    mRemote.transact(Stub.TRANSACTION_getPid, _data, _reply, <span class="number">0</span>);
                    _reply.readException();
                    _result = _reply.readInt();
                } <span class="keyword">finally</span> {
                    _reply.recycle();
                    _data.recycle();
                }
                <span class="keyword">return</span> _result;
            }

            <span class="javadoc">/**
             * Demonstrates some basic types that you can use as parameters
             * and return values in AIDL.
             */</span>
            <span class="annotation">@Override</span>
            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">basicTypes</span>(<span class="keyword">int</span> anInt, <span class="keyword">long</span> aLong, <span class="keyword">boolean</span> aBoolean, <span class="keyword">float</span> aFloat, <span class="keyword">double</span> aDouble, java.lang.String aString) <span class="keyword">throws</span> android.os.RemoteException {
                android.os.Parcel _data = android.os.Parcel.obtain();
                android.os.Parcel _reply = android.os.Parcel.obtain();
                <span class="keyword">try</span> {
                    _data.writeInterfaceToken(DESCRIPTOR);
                    _data.writeInt(anInt);
                    _data.writeLong(aLong);
                    _data.writeInt(((aBoolean) ? (<span class="number">1</span>) : (<span class="number">0</span>)));
                    _data.writeFloat(aFloat);
                    _data.writeDouble(aDouble);
                    _data.writeString(aString);
                    mRemote.transact(Stub.TRANSACTION_basicTypes, _data, _reply, <span class="number">0</span>);
                    _reply.readException();
                } <span class="keyword">finally</span> {
                    _reply.recycle();
                    _data.recycle();
                }
            }
        }

        <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TRANSACTION_getPid = (android.os.IBinder.FIRST_CALL_TRANSACTION + <span class="number">0</span>);
        <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TRANSACTION_basicTypes = (android.os.IBinder.FIRST_CALL_TRANSACTION + <span class="number">1</span>);
    }

    <span class="javadoc">/**
     * Request the process ID of this service, to do evil things with it.
     */</span>
    <span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPid</span>() <span class="keyword">throws</span> android.os.RemoteException;

    <span class="javadoc">/**
     * Demonstrates some basic types that you can use as parameters
     * and return values in AIDL.
     */</span>
    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">basicTypes</span>(<span class="keyword">int</span> anInt, <span class="keyword">long</span> aLong, <span class="keyword">boolean</span> aBoolean, <span class="keyword">float</span> aFloat, <span class="keyword">double</span> aDouble, java.lang.String aString) <span class="keyword">throws</span> android.os.RemoteException;
}
</pre></td></tr></table></figure>


<h3 id="service端实现接口。">service端实现接口。</h3>
<p>上述生成的java有内部类Stub，它继承自android.os.Binder对象并抽象实现了aidl接口。service需要继承Stub对象，并实现抽象接口。代码如下，mBinder对象将在client绑定service时返回。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre><span class="keyword">private</span> <span class="keyword">final</span> IRemoteService.Stub mBinder = <span class="keyword">new</span> IRemoteService.Stub() {
    <span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPid</span>(){
        <span class="keyword">return</span> Process.myPid();
    }
    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">basicTypes</span>(<span class="keyword">int</span> anInt, <span class="keyword">long</span> aLong, <span class="keyword">boolean</span> aBoolean,
        <span class="keyword">float</span> aFloat, <span class="keyword">double</span> aDouble, String aString) {
        <span class="comment">// Does nothing</span>
    }
};
</pre></td></tr></table></figure>


<h3 id="service返回接口对象给client。">service返回接口对象给client。</h3>
<p>service将实现Stub的对象返回给client端，代码如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="code"><pre><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoteService</span> <span class="keyword">extends</span> <span class="title">Service</span> {</span>
    <span class="annotation">@Override</span>
    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span>() {
        <span class="keyword">super</span>.onCreate();
    }

    <span class="annotation">@Override</span>
    <span class="keyword">public</span> IBinder <span class="title">onBind</span>(Intent intent) {
        <span class="comment">// Return the interface</span>
        <span class="keyword">return</span> mBinder;
    }

    <span class="keyword">private</span> <span class="keyword">final</span> IRemoteService.Stub mBinder = <span class="keyword">new</span> IRemoteService.Stub() {
        <span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPid</span>(){
            <span class="keyword">return</span> Process.myPid();
        }
        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">basicTypes</span>(<span class="keyword">int</span> anInt, <span class="keyword">long</span> aLong, <span class="keyword">boolean</span> aBoolean,
            <span class="keyword">float</span> aFloat, <span class="keyword">double</span> aDouble, String aString) {
            <span class="comment">// Does nothing</span>
        }
    };
}
</pre></td></tr></table></figure>


<h3 id="client获取service端接口。">client获取service端接口。</h3>
<p>在onServiceConnected中，通过调用Stub.asInterface获得service接口对象。通过这个对象，client就可以直接调用service操作了。代码如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="code"><pre>Intent intent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, RemoteService.class);
bindService(intent, mConnection, Context.BIND_AUTO_CREATE);

IRemoteService mIRemoteService;
<span class="keyword">private</span> ServiceConnection mConnection = <span class="keyword">new</span> ServiceConnection() {
    <span class="comment">// Called when the connection with the service is established</span>
    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span>(ComponentName className, IBinder service) {
        <span class="comment">// Following the example above for an AIDL interface,</span>
        <span class="comment">// this gets an instance of the IRemoteInterface, which we can use to call on the service</span>
        mIRemoteService = IRemoteService.Stub.asInterface(service);
    }

    <span class="comment">// Called when the connection with the service disconnects unexpectedly</span>
    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span>(ComponentName className) {
        Log.e(TAG, <span class="string">"Service has unexpectedly disconnected"</span>);
        mIRemoteService = <span class="keyword">null</span>;
    }
};
</pre></td></tr></table></figure>


<h1 id="绑定Service。">绑定Service。</h1>
<p>client实现ServiceConnection接口，并且调用bindService()绑定，调用unBindService()解除绑定。以上例子都有实现，这里不再重复代码。下面是需要注意的点.<br>（1）如果service仅仅通过bindService()启动（onStartCommand()未被调用过），则在bindService()的第三个参数应该写为BIND_AUTO_CREATE，在Service未启动时，它会create一个Service并且与其绑定。<br>（2）如果Service仅仅通过bindService()启动，则Android系统会自动管理Service的生命周期，在它所有client都解绑后，自动destory。如果onStartCommand()被调用过，则需要我们自己维护它的生命周期，调用stopSelf()或stopService()销毁Service。</p>
  
	</div>
		<footer class="article-footer clearfix">

  <div class="article-tags">
  
  <span></span> <a href="/tags/service/">service</a>
  </div>


<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Android/">Android</a>
</div>



<div class="article-share" id="share">

  <div data-url="https://github.com/Michaelgeek/2015/10/19/bound-services/" data-title="Bound Services | Michael&#39;s Blog" data-tsina="2667181007" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2015/11/15/rxjava/" title="RxJava">
  <strong>PREVIOUS:</strong><br/>
  <span>
  RxJava</span>
</a>
</div>


<div class="next">
<a href="/2015/09/16/总结：使用过的优秀开源库或框架/"  title="总结：使用过的优秀开源库或框架">
 <strong>NEXT:</strong><br/> 
 <span>总结：使用过的优秀开源库或框架
</span>
</a>
</div>

</nav>

	
<section class="comment">
	<div class="ds-thread"></div>
</section>

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
  <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#什么是Bound_Services？"><span class="toc-number">1.</span> <span class="toc-text">什么是Bound Services？</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#构造一个Bound_Services"><span class="toc-number">2.</span> <span class="toc-text">构造一个Bound Services</span></a></li><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#直接实现IBinder接口。"><span class="toc-number">2.1.</span> <span class="toc-text">直接实现IBinder接口。</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用Messenger（Messenger的内部也是使用AIDL实现的）。"><span class="toc-number">2.2.</span> <span class="toc-text">使用Messenger（Messenger的内部也是使用AIDL实现的）。</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用AIDL"><span class="toc-number">2.3.</span> <span class="toc-text">使用AIDL</span></a></li><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建-aidl文件。"><span class="toc-number">2.3.1.</span> <span class="toc-text">创建.aidl文件。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#service端实现接口。"><span class="toc-number">2.3.2.</span> <span class="toc-text">service端实现接口。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#service返回接口对象给client。"><span class="toc-number">2.3.3.</span> <span class="toc-text">service返回接口对象给client。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#client获取service端接口。"><span class="toc-number">2.3.4.</span> <span class="toc-text">client获取service端接口。</span></a></li></ol></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#绑定Service。"><span class="toc-number">3.</span> <span class="toc-text">绑定Service。</span></a></li></ol>
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
			<li><a href="/categories/Android/" title="Android">Android<sup>7</sup></a></li>
		
			<li><a href="/categories/工具/" title="工具">工具<sup>1</sup></a></li>
		
			<li><a href="/categories/工具库/" title="工具库">工具库<sup>1</sup></a></li>
		
			<li><a href="/categories/生活/" title="生活">生活<sup>1</sup></a></li>
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			<li><a href="/tags/Android studio/" title="Android studio">Android studio<sup>1</sup></a></li>
		
			<li><a href="/tags/Animation/" title="Animation">Animation<sup>1</sup></a></li>
		
			<li><a href="/tags/Gradle/" title="Gradle">Gradle<sup>1</sup></a></li>
		
			<li><a href="/tags/Layout/" title="Layout">Layout<sup>1</sup></a></li>
		
			<li><a href="/tags/RenderScript/" title="RenderScript">RenderScript<sup>1</sup></a></li>
		
			<li><a href="/tags/RxJava/" title="RxJava">RxJava<sup>1</sup></a></li>
		
			<li><a href="/tags/blog/" title="blog">blog<sup>1</sup></a></li>
		
			<li><a href="/tags/http/" title="http">http<sup>1</sup></a></li>
		
			<li><a href="/tags/service/" title="service">service<sup>1</sup></a></li>
		
		</ul>
</div>


  <div class="rsspart">
	<a href="http://michaelgeek.github.io/" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Believe it or not, Coding changes the world <br/>
			Passion makes dream come true!</p>
	</section>
	 
	<div class="social-font clearfix">
		
		<a href="http://weibo.com/2667181007" target="_blank" title="weibo"></a>
		
		
		
		<a href="https://github.com/Michaelgeek" target="_blank" title="github"></a>
		
		
		<a href="https://www.facebook.com/kongyouji" target="_blank" title="facebook"></a>
		
		
	</div>
		<p class="copyright">Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/A-limon/pacman" target="_blank" title="Pacman">Pacman</a> © 2015 
		
		<a href="https://github.com/Michaelgeek" target="_blank" title="Michael">Michael</a>
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>


<script type="text/javascript">
  var duoshuoQuery = {short_name:"null"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 





  </body>
</html>
